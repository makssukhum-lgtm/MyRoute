{% extends "admin/base.html" %}
{% load static %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        :root {
            --bubble-admin: #0084ff;
            --bubble-user: #e4e6eb;
            --text-light: #ffffff;
            --text-dark: #050505;
        }
        #chat-log {
            height: 60vh;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message-wrapper { display: flex; flex-direction: column; max-width: 75%; }
        .message { padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
        .message-meta { font-size: 0.75rem; color: #666; margin-top: 5px; padding: 0 5px; }
        .admin { align-self: flex-end; align-items: flex-end; }
        .admin .message { background-color: var(--bubble-admin); color: var(--text-light); }
        .user { align-self: flex-start; align-items: flex-start; }
        .user .message { background-color: var(--bubble-user); color: var(--text-dark); }
        .chat-input { display: flex; gap: 10px; }
        #chat-message-input { flex-grow: 1; resize: none; }
    </style>
{% endblock %}

{% block content_title %}
    <h1>Чат по обращению #{{ ticket.id }} от {{ ticket.user.name }}</h1>
{% endblock %}

{% block content %}
<div id="content-main">
    <div id="chat-log">
        <!-- Первое сообщение тикета -->
        <div class="message-wrapper user">
            <div class="message"><b>{{ ticket.user.name }}:</b><br>{{ ticket.message }}</div>
            <div class="message-meta">{{ ticket.created_at|date:"d.m.Y H:i" }}</div>
        </div>

        <!-- История переписки -->
        {% for msg in chat_messages %}
            {% if msg.author.is_staff %}
                <div class="message-wrapper admin">
                    <div class="message"><b>Вы:</b><br>{{ msg.message }}</div>
                    <div class="message-meta">{{ msg.timestamp|date:"d.m.Y H:i" }}</div>
                </div>
            {% else %}
                <div class="message-wrapper user">
                    <div class="message"><b>{{ msg.author.name }}:</b><br>{{ msg.message }}</div>
                    <div class="message-meta">{{ msg.timestamp|date:"d.m.Y H:i" }}</div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="chat-input">
        <textarea id="chat-message-input" class="vLargeTextField" placeholder="Введите ваш ответ..." rows="3"></textarea>
        <button id="chat-message-submit" class="button btn-primary">Отправить</button>
    </div>

    {{ ticket.id|json_script:"ticket-id" }}
    {{ request.user.name|json_script:"user-username" }}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ticketId = JSON.parse(document.getElementById('ticket-id').textContent);
        const username = JSON.parse(document.getElementById('user-username').textContent);
        const chatLog = document.getElementById('chat-log');

        chatLog.scrollTop = chatLog.scrollHeight;

        const chatSocket = new WebSocket(
            (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
            + window.location.host
            + '/ws/support/'
            + ticketId
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            const metaDiv = document.createElement('div');
            metaDiv.classList.add('message-meta');
            
            const nameBold = document.createElement('b');
            messageDiv.appendChild(nameBold);
            messageDiv.appendChild(document.createElement('br'));
            messageDiv.appendChild(document.createTextNode(data.message));
            
            if (data.username === username) {
                messageWrapper.classList.add('admin');
                nameBold.textContent = 'Вы:';
            } else {
                messageWrapper.classList.add('user');
                nameBold.textContent = data.username + ':';
            }
            
            metaDiv.textContent = new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageWrapper.appendChild(messageDiv);
            messageWrapper.appendChild(metaDiv);
            chatLog.appendChild(messageWrapper);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const input = document.getElementById('chat-message-input');
        const submitButton = document.getElementById('chat-message-submit');

        function sendMessage() {
            if (input.value.trim() === '') return;
            chatSocket.send(JSON.stringify({ 'message': input.value }));
            input.value = '';
            input.focus();
        }

        submitButton.onclick = sendMessage;
        input.addEventListener('keyup', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    });
</script>
{% endblock %}
